import ballerina/grpc;
import ballerina/io;
import ballerina/log;

listener grpc:Listener ep = new (9092);

//USING This variable to allow the user to enter a file name for the json file(currently not functional)
        string fileName = "Record";
    
        //path to json file location
        string filePath = "./files/" + fileName + ".json";
        

service cali on ep {
   
    resource function addRecord(grpc:Caller caller, addRequest value, json content, string path, io:WritableCharacterChannel wc) returns @tainted error?{ //, io:ReadableCSVChannel csvChannel, io:WritableCSVChannel wCsvChannel)
        //Create an object of type updateRequest check caller->send(resp);(to enable addition of key)
        check caller->send("Server is processing......");

        //Craete a json from the user provided informtion and hashfunction key
        
        json newSong = {
            songKey: "hashFunction Provides",
            songVersion: value.songVersion,
            date: value.date,
            allArtists: value.allArtists,
            band: value.band,
            songDetails: value.songDetails

        }; 
       

        //Open Write Channel
    
        io:WritableByteChannel wbc = check io:openWritableFile(path);

        io:WritableCharacterChannel wch = new (wbc, "UTF8");
        var result = wch.writeJson(content);
        closeWc(wch);
        return result;

                
        io:println("WRITING TO JSON FILE.......");

        var wResult = write(j1, filePath);
        if (wResult is error) {
        log:printError("Error occurred while writing json: ", wResult);
        } else {
        io:println("Preparing to read the content written");
        }
        var rResult = read(filePath);
        if (rResult is error) {
            log:printError("Error occurred while reading json: ",
                            err = rResult);
        } else {
            io:println(rResult.toJsonString());
        }
      
    //Close write channel

        var result = wc.close();
        if (result is error) {
            log:printError("Error occurred while closing character stream",err = result);
        }        
        
        addResponse resp = {
                addStatus: "Record Successfully Added",
                songVersion: value.songVersion,
                songKey: update.songKey
                };

                check caller->send(resp);
                 check caller->complete();

    }
    resource function updateRecord(grpc:Caller caller, updateRequest value, string path) {
        // Implementation goes here.
        json newSong = {
            songKey: "hashFunction Provides",
            songVersion: value.songVersion,
            date: value.date,
            allArtists: value.allArtists,
            band: value.band,
            songDetails: value.songDetails

        }; 
       

        //Open Write Channel
    
        io:WritableByteChannel wbc = check io:openWritableFile(path);

        io:WritableCharacterChannel wch = new (wbc, "UTF8");
        var result = wch.writeJson(content);
        closeWc(wch);
        return result;

                
        io:println("WRITING TO JSON FILE.......");

        var wResult = write(j1, filePath);
        if (wResult is error) {
        log:printError("Error occurred while writing json: ", wResult);
        } else {
        io:println("Preparing to read the content written");
        }
        var rResult = read(filePath);
        if (rResult is error) {
            log:printError("Error occurred while reading json: ",
                            err = rResult);
        } else {
            io:println(rResult.toJsonString());
        }
      
    //Close write channel

        var result = wc.close();
        if (result is error) {
            log:printError("Error occurred while closing character stream",err = result);
        }        
        
        addResponse resp = {
                addStatus: "Record Successfully Added",
                songVersion: value.songVersion,
                songKey: update.songKey
                };

                check caller->send(resp);
                 check caller->complete();
        // You should return a updateResponse
    }
    resource function readRecord(grpc:Caller caller, readRequest value, string path) {
        // Implementation goes here.
         io:ReadableByteChannel rbc = check io:openReadableFile(path);

        io:ReadableCharacterChannel rch = new (rbc, "UTF8");
        var result = rch.readJson();
        closeRc(rch);
        return result;

        //Close read channel 

        
        var result = rc.close();
        if (result is error) {
        log:printError("Error occurred while closing character stream",err = result);
        }
        // You should return a readResponse
    }
}

public type addRequest record {|
    string songVersion = "";
    string date = "";
    artistDetails[] allArtists = [];
    string band = "";
    song[] songDetails = [];
    
|};

public type artistDetails record {|
    string name = "";
    string member = "";
    
|};


public type song record {|
    string title = "";
    string genre = "";
    string platform = "";
    
|};


public type updateRequest record {|
    string songKey = "";
    string songVersion = "";
    string date = "";
    updateartistDetails[] allArtists = [];
    string band = "";
    updatesong[] songDetails = [];
    
|};

public type updateartistDetails record {|
    string name = "";
    string member = "";
    
|};


public type updatesong record {|
    string title = "";
    string genre = "";
    string platform = "";
    
|};


public type readRequest record {|
    string songKey = "";
    string songVersion = "";
    string date = "";
    readartistDetails[] allArtists = [];
    string band = "";
    readsong[] songDetails = [];
    
|};

public type readartistDetails record {|
    string name = "";
    string member = "";
    
|};


public type readsong record {|
    string title = "";
    string genre = "";
    string platform = "";
    
|};


public type addResponse record {|
    string addStatus = "";
    string songVersion = "";
    string songKey = "";
    
|};

public type updateResponse record {|
    string updateStatus = "";
    updateRequest? newVersion = ();
    
|};

public type readResponse record {|
    string readStatus = "";
    updateRequest[] readResult = [];
    
|};



const string ROOT_DESCRIPTOR = "0A0A417373312E70726F746F22D2020A0A6164645265717565737412200A0B736F6E6756657273696F6E180120012809520B736F6E6756657273696F6E12120A046461746518022001280952046461746512390A0A616C6C4172746973747318032003280B32192E616464526571756573742E61727469737444657461696C73520A616C6C4172746973747312120A0462616E64180420012809520462616E6412320A0B736F6E6744657461696C7318052003280B32102E616464526571756573742E736F6E67520B736F6E6744657461696C731A3B0A0D61727469737444657461696C7312120A046E616D6518012001280952046E616D6512160A066D656D62657218022001280952066D656D6265721A4E0A04736F6E6712140A057469746C6518012001280952057469746C6512140A0567656E7265180220012809520567656E7265121A0A08706C6174666F726D1803200128095208706C6174666F726D228D030A0D7570646174655265717565737412180A07736F6E674B65791801200128095207736F6E674B657912200A0B736F6E6756657273696F6E180220012809520B736F6E6756657273696F6E12120A046461746518032001280952046461746512420A0A616C6C4172746973747318042003280B32222E757064617465526571756573742E75706461746561727469737444657461696C73520A616C6C4172746973747312120A0462616E64180520012809520462616E64123B0A0B736F6E6744657461696C7318062003280B32192E757064617465526571756573742E757064617465736F6E67520B736F6E6744657461696C731A410A1375706461746561727469737444657461696C7312120A046E616D6518012001280952046E616D6512160A066D656D62657218022001280952066D656D6265721A540A0A757064617465736F6E6712140A057469746C6518012001280952057469746C6512140A0567656E7265180220012809520567656E7265121A0A08706C6174666F726D1803200128095208706C6174666F726D22FF020A0B726561645265717565737412180A07736F6E674B65791801200128095207736F6E674B657912200A0B736F6E6756657273696F6E180220012809520B736F6E6756657273696F6E12120A0464617465180320012809520464617465123E0A0A616C6C4172746973747318042003280B321E2E72656164526571756573742E7265616461727469737444657461696C73520A616C6C4172746973747312120A0462616E64180520012809520462616E6412370A0B736F6E6744657461696C7318062003280B32152E72656164526571756573742E72656164736F6E67520B736F6E6744657461696C731A3F0A117265616461727469737444657461696C7312120A046E616D6518012001280952046E616D6512160A066D656D62657218022001280952066D656D6265721A520A0872656164736F6E6712140A057469746C6518012001280952057469746C6512140A0567656E7265180220012809520567656E7265121A0A08706C6174666F726D1803200128095208706C6174666F726D22670A0B616464526573706F6E7365121C0A09616464537461747573180120012809520961646453746174757312200A0B736F6E6756657273696F6E180220012809520B736F6E6756657273696F6E12180A07736F6E674B65791803200128095207736F6E674B657922640A0E757064617465526573706F6E736512220A0C757064617465537461747573180120012809520C757064617465537461747573122E0A0A6E657756657273696F6E18022001280B320E2E75706461746552657175657374520A6E657756657273696F6E225E0A0C72656164526573706F6E7365121E0A0A72656164537461747573180120012809520A72656164537461747573122E0A0A72656164526573756C7418022003280B320E2E75706461746552657175657374520A72656164526573756C74328A010A0463616C6912260A096164645265636F7264120B2E616464526571756573741A0C2E616464526573706F6E7365122F0A0C7570646174655265636F7264120E2E757064617465526571756573741A0F2E757064617465526573706F6E736512290A0A726561645265636F7264120C2E72656164526571756573741A0D2E72656164526573706F6E7365620670726F746F33";
function getDescriptorMap() returns map<string> {
    return {
        "Ass1.proto":"0A0A417373312E70726F746F22D2020A0A6164645265717565737412200A0B736F6E6756657273696F6E180120012809520B736F6E6756657273696F6E12120A046461746518022001280952046461746512390A0A616C6C4172746973747318032003280B32192E616464526571756573742E61727469737444657461696C73520A616C6C4172746973747312120A0462616E64180420012809520462616E6412320A0B736F6E6744657461696C7318052003280B32102E616464526571756573742E736F6E67520B736F6E6744657461696C731A3B0A0D61727469737444657461696C7312120A046E616D6518012001280952046E616D6512160A066D656D62657218022001280952066D656D6265721A4E0A04736F6E6712140A057469746C6518012001280952057469746C6512140A0567656E7265180220012809520567656E7265121A0A08706C6174666F726D1803200128095208706C6174666F726D228D030A0D7570646174655265717565737412180A07736F6E674B65791801200128095207736F6E674B657912200A0B736F6E6756657273696F6E180220012809520B736F6E6756657273696F6E12120A046461746518032001280952046461746512420A0A616C6C4172746973747318042003280B32222E757064617465526571756573742E75706461746561727469737444657461696C73520A616C6C4172746973747312120A0462616E64180520012809520462616E64123B0A0B736F6E6744657461696C7318062003280B32192E757064617465526571756573742E757064617465736F6E67520B736F6E6744657461696C731A410A1375706461746561727469737444657461696C7312120A046E616D6518012001280952046E616D6512160A066D656D62657218022001280952066D656D6265721A540A0A757064617465736F6E6712140A057469746C6518012001280952057469746C6512140A0567656E7265180220012809520567656E7265121A0A08706C6174666F726D1803200128095208706C6174666F726D22FF020A0B726561645265717565737412180A07736F6E674B65791801200128095207736F6E674B657912200A0B736F6E6756657273696F6E180220012809520B736F6E6756657273696F6E12120A0464617465180320012809520464617465123E0A0A616C6C4172746973747318042003280B321E2E72656164526571756573742E7265616461727469737444657461696C73520A616C6C4172746973747312120A0462616E64180520012809520462616E6412370A0B736F6E6744657461696C7318062003280B32152E72656164526571756573742E72656164736F6E67520B736F6E6744657461696C731A3F0A117265616461727469737444657461696C7312120A046E616D6518012001280952046E616D6512160A066D656D62657218022001280952066D656D6265721A520A0872656164736F6E6712140A057469746C6518012001280952057469746C6512140A0567656E7265180220012809520567656E7265121A0A08706C6174666F726D1803200128095208706C6174666F726D22670A0B616464526573706F6E7365121C0A09616464537461747573180120012809520961646453746174757312200A0B736F6E6756657273696F6E180220012809520B736F6E6756657273696F6E12180A07736F6E674B65791803200128095207736F6E674B657922640A0E757064617465526573706F6E736512220A0C757064617465537461747573180120012809520C757064617465537461747573122E0A0A6E657756657273696F6E18022001280B320E2E75706461746552657175657374520A6E657756657273696F6E225E0A0C72656164526573706F6E7365121E0A0A72656164537461747573180120012809520A72656164537461747573122E0A0A72656164526573756C7418022003280B320E2E75706461746552657175657374520A72656164526573756C74328A010A0463616C6912260A096164645265636F7264120B2E616464526571756573741A0C2E616464526573706F6E7365122F0A0C7570646174655265636F7264120E2E757064617465526571756573741A0F2E757064617465526573706F6E736512290A0A726561645265636F7264120C2E72656164526571756573741A0D2E72656164526573706F6E7365620670726F746F33"
        
    };
}

